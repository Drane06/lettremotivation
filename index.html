<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lettre de motivation — Aperçu</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .edit-page {
      width: 210mm;
      min-height: 297mm;
      padding: 20mm;
    }

    textarea,
    input {
      text-align: justify;
    }

    .feedback {
      transition: all 0.3s ease-in-out;
    }

    .feedback.success {
      background: #e8f5e8;
      color: #2d5a2d;
      border-color: #4caf50;
    }

    .feedback.warning {
      background: #fff3cd;
      color: #856404;
      border-color: #ffc107;
    }

    .feedback.error {
      background: #f8d7da;
      color: #721c24;
      border-color: #dc3545;
    }

    .feedback-ai {
      border-left: 4px solid #667eea;
      background-color: #f0f4ff;
      color: #333;
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 0.5rem;
      font-style: italic;
      white-space: pre-line;
      line-height: 1.5;
    }

    #preview-content {
      font-family: 'Times New Roman', serif;
      font-size: 12pt;
      line-height: 1.5;
    }

    .preview-print-coords {
      margin-bottom: 20mm;
    }

    .preview-print-objet {
      margin: 15mm 0;
      font-weight: bold;
      text-align: left;
    }

    .preview-print-right {
      text-align: right;
    }

    .preview-print-signature {
      margin-top: 20mm;
      text-align: right;
    }

    @media print {
      body {
        background: white;
        padding: 0;
        font-family: 'Times New Roman', serif;
      }

      .container,
      .print-button,
      .sidebar,
      #main-page,
      .copy-button,
      .view-button {
        display: none !important;
      }

      #print-content {
        display: block !important;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        box-shadow: none;
        padding: 15mm;
      }

      #print-content p,
      #print-content h1,
      #print-content h2,
      #print-content div {
        margin: 0;
        padding: 0;
      }

      #print-content p {
        text-align: justify;
        margin-bottom: 0.5rem;
      }
    }

    @media (max-width: 1024px) {
      .container {
        grid-template-columns: 1fr;
      }

      .edit-page {
        width: 100%;
      }
    }
  </style>
</head>

<body>
  <div class="container mx-auto grid grid-cols-1 lg:grid-cols-[1fr_300px] gap-5 p-5">
    <div id="main-page" class="edit-page bg-white shadow-xl rounded-lg text-sm leading-relaxed p-8">
      <p class="mb-4">
        Ce paragraphe est un outil destiné à vous accompagner dans la rédaction de votre première lettre de motivation, étape par étape.
        Pour une présentation soignée et conforme aux normes, commencez toujours votre texte aligné sur la marge de gauche.
        Évitez de faire des alinéas : préférez plutôt sauter une ligne entre chaque paragraphe afin d’aérer votre texte.
        Veillez également à justifier l’ensemble du texte sur la marge de droite.
        Enfin, tenez compte à la fois du guide de rédaction situé à droite et des conseils donnés lors de la correction.
      </p>
      <div class="flex flex-col sm:flex-row justify-between mb-8">
        <div class="field w-full sm:w-1/2 mb-4 sm:mb-0 relative">
          <button onclick="corriger('coordonnees')"
            class="absolute top-[-30px] right-0 z-10 bg-blue-500 text-white text-xs px-4 py-1.5 rounded-full shadow-md hover:bg-blue-600 transition-all duration-300 transform hover:-translate-y-1">
            📝 Corriger
          </button>
          <textarea id="coordonnees" rows="4"
            class="w-full border-2 border-gray-200 rounded-md p-2 bg-gray-50 focus:border-blue-500 focus:bg-white transition-all resize-y"
            placeholder="Vos coordonnées complètes ici..."></textarea>
          <div id="fb-coordonnees" class="feedback p-2 mt-2 rounded-md hidden"></div>
          <div id="fb-ia-coordonnees" class="feedback-ai hidden"></div>
        </div>
        <div class="right-block w-full sm:w-1/2 flex flex-col items-end">
          <div class="field right mb-4 relative">
            <button onclick="corriger('entreprise')"
              class="absolute top-[-30px] right-0 z-10 bg-blue-500 text-white text-xs px-4 py-1.5 rounded-full shadow-md hover:bg-blue-600 transition-all duration-300 transform hover:-translate-y-1">
              📝 Corriger
            </button>
            <textarea id="entreprise" rows="3"
              class="w-full border-2 border-gray-200 rounded-md p-2 bg-gray-50 focus:border-blue-500 focus:bg-white transition-all resize-y"
              placeholder="Coordonnées du destinataire..."></textarea>
            <div id="fb-entreprise" class="feedback p-2 mt-2 rounded-md hidden"></div>
            <div id="fb-ia-entreprise" class="feedback-ai hidden"></div>
          </div>
          <div class="field right mb-4 relative">
            <button onclick="corriger('date')"
              class="absolute top-[-30px] right-0 z-10 bg-blue-500 text-white text-xs px-4 py-1.5 rounded-full shadow-md hover:bg-blue-600 transition-all duration-300 transform hover:-translate-y-1">
              📝 Corriger
            </button>
            <input id="date"
              class="w-full border-2 border-gray-200 rounded-md p-2 bg-gray-50 focus:border-blue-500 focus:bg-white transition-all"
              placeholder="Fait à Paris, le 9 février 2026" />
            <div id="fb-date" class="feedback p-2 mt-2 rounded-md hidden"></div>
            <div id="fb-ia-date" class="feedback-ai hidden"></div>
          </div>
        </div>
      </div>
      <div class="field objet relative">
        <button onclick="corriger('objet')"
          class="absolute top-[-30px] right-0 z-10 bg-blue-500 text-white text-xs px-4 py-1.5 rounded-full shadow-md hover:bg-blue-600 transition-all duration-300 transform hover:-translate-y-1">
          📝 Corriger
        </button>
        <input id="objet"
          class="w-full font-bold border-2 border-gray-200 rounded-md p-2 bg-gray-50 focus:border-blue-500 focus:bg-white transition-all"
          placeholder="Objet : Demande de stage d'observation du 9 au 13 février 2026" />
        <div id="fb-objet" class="feedback p-2 mt-2 rounded-md hidden"></div>
        <div id="fb-ia-objet" class="feedback-ai hidden"></div>
      </div>
      <div class="field relative">
        <button onclick="corriger('salutation')"
          class="absolute top-[-30px] right-0 z-10 bg-blue-500 text-white text-xs px-4 py-1.5 rounded-full shadow-md hover:bg-blue-600 transition-all duration-300 transform hover:-translate-y-1">
          📝 Corriger
        </button>
        <input id="salutation"
          class="w-full border-2 border-gray-200 rounded-md p-2 bg-gray-50 focus:border-blue-500 focus:bg-white transition-all"
          placeholder="Madame, Monsieur," />
        <div id="fb-salutation" class="feedback p-2 mt-2 rounded-md hidden"></div>
        <div id="fb-ia-salutation" class="feedback-ai hidden"></div>
      </div>
      <div class="field relative">
        <button onclick="corriger('intro')"
          class="absolute top-[-30px] right-0 z-10 bg-blue-500 text-white text-xs px-4 py-1.5 rounded-full shadow-md hover:bg-blue-600 transition-all duration-300 transform hover:-translate-y-1">
          📝 Corriger
        </button>
        <textarea id="intro" rows="4"
          class="w-full border-2 border-gray-200 rounded-md p-2 bg-gray-50 focus:border-blue-500 focus:bg-white transition-all resize-y"
          placeholder="Paragraphe d'introduction..."></textarea>
        <div id="fb-intro" class="feedback p-2 mt-2 rounded-md hidden"></div>
        <div id="fb-ia-intro" class="feedback-ai hidden"></div>
      </div>
      <div class="field relative">
        <button onclick="corriger('developpement')"
          class="absolute top-[-30px] right-0 z-10 bg-blue-500 text-white text-xs px-4 py-1.5 rounded-full shadow-md hover:bg-blue-600 transition-all duration-300 transform hover:-translate-y-1">
          📝 Corriger
        </button>
        <textarea id="developpement" rows="6"
          class="w-full border-2 border-gray-200 rounded-md p-2 bg-gray-50 focus:border-blue-500 focus:bg-white transition-all resize-y"
          placeholder="Paragraphe de développement..."></textarea>
        <div id="fb-developpement" class="feedback p-2 mt-2 rounded-md hidden"></div>
        <div id="fb-ia-developpement" class="feedback-ai hidden"></div>
      </div>
      <div class="field relative">
        <button onclick="corriger('conclusion')"
          class="absolute top-[-30px] right-0 z-10 bg-blue-500 text-white text-xs px-4 py-1.5 rounded-full shadow-md hover:bg-blue-600 transition-all duration-300 transform hover:-translate-y-1">
          📝 Corriger
        </button>
        <textarea id="conclusion" rows="4"
          class="w-full border-2 border-gray-200 rounded-md p-2 bg-gray-50 focus:border-blue-500 focus:bg-white transition-all resize-y"
          placeholder="Paragraphe de conclusion..."></textarea>
        <div id="fb-conclusion" class="feedback p-2 mt-2 rounded-md hidden"></div>
        <div id="fb-ia-conclusion" class="feedback-ai hidden"></div>
      </div>
      <div class="field relative">
        <button onclick="corriger('politesse')"
          class="absolute top-[-30px] right-0 z-10 bg-blue-500 text-white text-xs px-4 py-1.5 rounded-full shadow-md hover:bg-blue-600 transition-all duration-300 transform hover:-translate-y-1">
          📝 Corriger
        </button>
        <input id="politesse"
          class="w-full border-2 border-gray-200 rounded-md p-2 bg-gray-50 focus:border-blue-500 focus:bg-white transition-all"
          placeholder="Je vous prie d'agréer, Madame, Monsieur, l'expression de mes salutations distinguées." />
        <div id="fb-politesse" class="feedback p-2 mt-2 rounded-md hidden"></div>
        <div id="fb-ia-politesse" class="feedback-ai hidden"></div>
      </div>
      <div class="field right mt-10 relative">
        <button onclick="corriger('signature')"
          class="absolute top-[-30px] right-0 z-10 bg-blue-500 text-white text-xs px-4 py-1.5 rounded-full shadow-md hover:bg-blue-600 transition-all duration-300 transform hover:-translate-y-1">
          📝 Corriger
        </button>
        <input id="signature"
          class="w-full border-2 border-gray-200 rounded-md p-2 bg-gray-50 focus:border-blue-500 focus:bg-white transition-all"
          placeholder="[Votre prénom et nom]" />
        <div id="fb-signature" class="feedback p-2 mt-2 rounded-md hidden"></div>
        <div id="fb-ia-signature" class="feedback-ai hidden"></div>
      </div>
    </div>
    <div id="preview-page" class="edit-page bg-white shadow-xl rounded-lg p-8" style="display:none;">
      <div id="preview-content"></div>
      <div class="flex justify-center mt-8">
        <button onclick="showEditPage()"
          class="view-button bg-gray-500 text-white text-lg px-6 py-3 rounded-full font-bold shadow-lg hover:bg-gray-600 transition-all duration-300 transform hover:-translate-y-1">
          Retour à l'édition
        </button>
      </div>
    </div>
    <div class="sidebar bg-white shadow-xl rounded-lg p-5 h-fit sticky top-5">
      <h2 class="text-xl font-bold mb-4">📚 Guide de rédaction</h2>
      <div class="progress h-2 bg-gray-200 rounded-full overflow-hidden mb-4">
        <div id="progress" class="progress-bar h-full w-0 bg-gradient-to-r from-blue-500 to-purple-500 transition-all duration-500">
        </div>
      </div>
      <p id="progress-text" class="text-sm text-gray-600 mb-6">Progression : 0/10 sections complétées</p>
      <div class="help-section p-4 bg-gray-100 rounded-lg border-l-4 border-blue-500 mb-4">
        <h3 class="font-semibold text-lg text-gray-800">📍 Coordonnées</h3>
        <p class="text-sm text-gray-600 mt-1">Vos informations personnelles complètes : nom, adresse, téléphone et email.
          Précisez que vous êtes élève de 3ème.</p>
      </div>
      <div class="help-section p-4 bg-gray-100 rounded-lg border-l-4 border-blue-500 mb-4">
        <h3 class="font-semibold text-lg text-gray-800">🏢 Destinataire</h3>
        <p class="text-sm text-gray-600 mt-1">Nom du responsable et adresse de l'entreprise. Recherchez le nom exact du
          responsable si possible.</p>
      </div>
      <div class="help-section p-4 bg-gray-100 rounded-lg border-l-4 border-blue-500 mb-4">
        <h3 class="font-semibold text-lg text-gray-800">📅 Date et lieu</h3>
        <p class="text-sm text-gray-600 mt-1">Lieu de rédaction et date complète. Format : "Fait à [ville], le [jour mois
          année]"</p>
      </div>
      <div class="help-section p-4 bg-gray-100 rounded-lg border-l-4 border-blue-500 mb-4">
        <h3 class="font-semibold text-lg text-gray-800">🎯 Objet</h3>
        <p class="text-sm text-gray-600 mt-1">Précisez "Demande de stage d'observation" avec les dates exactes du stage (9-13
          février 2026).</p>
      </div>
      <div class="help-section p-4 bg-gray-100 rounded-lg border-l-4 border-blue-500 mb-4">
        <h3 class="font-semibold text-lg text-gray-800">🎓 Introduction</h3>
        <p class="text-sm text-gray-600 mt-1">Présentez-vous comme élève de 3ème, mentionnez votre collège, expliquez le
          cadre obligatoire du stage et votre intérêt pour le domaine d'activité de l'entreprise.</p>
      </div>
      <div class="help-section p-4 bg-gray-100 rounded-lg border-l-4 border-blue-500 mb-4">
        <h3 class="font-semibold text-lg text-gray-800">💪 Développement</h3>
        <p class="text-sm text-gray-600 mt-1">Mettez en avant vos qualités personnelles, vos centres d'intérêt liés au
          domaine, vos résultats scolaires. Expliquez ce que vous espérez découvrir et apprendre.</p>
      </div>
      <div class="help-section p-4 bg-gray-100 rounded-lg border-l-4 border-blue-500 mb-4">
        <h3 class="font-semibold text-lg text-gray-800">🎯 Conclusion</h3>
        <p class="text-sm text-gray-600 mt-1">Montrez votre motivation pour découvrir les métiers de l'entreprise, proposez
          un entretien téléphonique ou une rencontre, et remerciez.</p>
      </div>
      <div class="help-section p-4 bg-gray-100 rounded-lg border-l-4 border-blue-500 mb-4">
        <h3 class="font-semibold text-lg text-gray-800">🤝 Formule de politesse</h3>
        <p class="text-sm text-gray-600 mt-1">Formule standard et respectueuse. Reprenez la civilité utilisée en début de
          lettre.</p>
      </div>
    </div>
  </div>
  <div class="flex justify-center md:justify-end gap-4 p-5 md:fixed md:bottom-8 md:right-8 md:p-0 z-50">
    <button onclick="showPreviewPage()"
      class="view-button bg-gray-500 text-white text-lg px-6 py-3 rounded-full font-bold shadow-lg hover:bg-gray-600 transition-all duration-300 transform hover:-translate-y-1">
      👀 Voir l'aperçu
    </button>
  </div>
  <div id="print-content" style="display: none;"></div>
  <textarea id="copy-area" style="position: absolute; left: -9999px;"></textarea>
  <div id="loading-modal"
    class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center hidden z-[1001]">
    <div class="bg-white p-6 rounded-lg text-center shadow-xl">
      <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-blue-500 mx-auto mb-4"></div>
      <p class="text-gray-700 font-medium">Correction et analyse en cours...</p>
    </div>
  </div>
  <div id="message-modal"
    class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center hidden z-[1002]">
    <div class="bg-white p-6 rounded-lg text-center shadow-xl max-w-sm">
      <h3 class="text-xl font-bold mb-4"></h3>
      <p class="text-gray-700 mb-6"></p>
      <div class="flex justify-center gap-4">
        <button id="modal-close"
          class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">OK</button>
      </div>
    </div>
  </div>
  <script>
    async function corrigerAvecIA(text, typeSection) {
      const prompt = `En tant que tuteur bienveillant et pédagogue, analyse le texte suivant d'un(e) élève de 3ème qui rédige une lettre de motivation. Ton rôle est de lui donner des conseils constructifs et personnalisés pour améliorer son texte, en t'appuyant sur le guide de rédaction à droite. Tu dois :
      1. Vérifier la clarté, le ton et la structure de la section.
      2. Repérer les faiblesses et les points à améliorer.
      3. Proposer des suggestions concrètes pour rendre son texte plus impactant, sans le réécrire complètement.
      4. Adapter le niveau de tes conseils à un(e) collégien(ne).
      5. Ne mentionne pas que tu es une IA.
      6. Formate ta réponse en une seule phrase. Par exemple: "Je pense qu'il manque le nom du collège."
      Voici le texte de la section '${typeSection}':
      """
      ${text}
      """
      `;
      let attempts = 0;
      const maxAttempts = 3;
      let aiAdvice = '';
      while (attempts < maxAttempts) {
        try {
          const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
          const payload = { contents: chatHistory };
          const apiKey = "";
          const apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=" + apiKey;
          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (!response.ok) {
            throw new Error(`API call failed with status: ${response.status}`);
          }
          const result = await response.json();
          if (result.candidates && result.candidates.length > 0 &&
            result.candidates[0].content && result.candidates[0].content.parts &&
            result.candidates[0].content.parts.length > 0) {
            aiAdvice = result.candidates[0].content.parts[0].text;
            break;
          } else {
            console.error("Unexpected API response structure:", result);
            throw new Error("API response was not as expected.");
          }
        } catch (error) {
          console.error("Error correcting text with IA:", error);
          attempts++;
          if (attempts < maxAttempts) {
            const delay = Math.pow(2, attempts) * 1000;
            await new Promise(res => setTimeout(res, delay));
          } else {
            return "Une erreur est survenue lors de l'analyse par l'IA. Veuillez réessayer plus tard.";
          }
        }
      }
      return aiAdvice;
    }

    function analyserReponseEleve(texte, typeSection) {
      switch (typeSection) {
        case 'intro': return analyserIntroduction(texte);
        case 'developpement': return analyserDeveloppement(texte);
        case 'conclusion': return analyserConclusion(texte);
        case 'coordonnees': return analyserCoordonnees(texte);
        case 'objet': return analyserObjet(texte);
        case 'salutation':
        case 'politesse':
        case 'signature':
        case 'date':
        case 'entreprise':
        default: return analyserGeneral(texte, typeSection);
      }
    }

    function analyserIntroduction(texte) {
      const analyse = { forces: [], faiblesses: [], corrections: [], suggestions: [] };
      const phrases = texte.split(/[.!?]+/).filter(p => p.trim().length > 5);
      if (phrases.length < 2) {
        analyse.faiblesses.push("Votre introduction est trop courte. Développez en 2-3 phrases minimum.");
      }
      if (!/élève|3ème|troisième|collège|classe/i.test(texte)) {
        analyse.faiblesses.push("Vous ne vous présentez pas comme élève de 3ème. Mentionnez votre statut scolaire.");
      } else {
        analyse.forces.push("Parfait ! Vous vous présentez bien comme élève de 3ème.");
      }
      if (!/stage|observation|découvert|obligatoire|séquence/i.test(texte)) {
        analyse.faiblesses.push("Vous n'expliquez pas le contexte du stage d'observation.");
      } else {
        analyse.forces.push("Bien ! Vous mentionnez le contexte du stage d'observation.");
      }
      if (!/intéresse|attire|passionne|découvrir|métier|domaine|activité/i.test(texte)) {
        analyse.faiblesses.push("Vous n'exprimez pas votre intérêt pour le domaine d'activité.");
      }
      if (/candidature|postule|emploi|embauche/i.test(texte)) {
        analyse.corrections.push("Évitez le vocabulaire de candidature d'emploi. Vous demandez un stage d'observation, pas un travail.");
      }
      return analyse;
    }

    function analyserDeveloppement(texte) {
      const analyse = { forces: [], faiblesses: [], corrections: [], suggestions: [] };
      const phrases = texte.split(/[.!?]+/).filter(p => p.trim().length > 10);
      if (phrases.length < 3) {
        analyse.faiblesses.push("Votre développement est trop court. Développez en 4-5 phrases minimum.");
      }
      const elementsEleve = {
        qualites: /qualité|rigoureux|sérieux|curieux|motivé|organisé|autonome|sociable/i.test(texte),
        interets: /passion|intérêt|aime|centre d'intérêt|hobby|activité|sport/i.test(texte),
        scolaire: /note|résultat|bulletin|matière|cours|professeur|établissement/i.test(texte),
        objectifs: /apprendre|découvrir|comprendre|observer|voir|connaître|espère|souhaite/i.test(texte)
      };
      const elementsPresents = Object.keys(elementsEleve).filter(key => elementsEleve[key]);
      if (elementsPresents.length < 2) {
        analyse.faiblesses.push("Votre profil d'élève manque d'éléments. Mentionnez au moins 2 aspects parmi : qualités personnelles, centres d'intérêt, résultats scolaires, objectifs du stage.");
      } else {
        analyse.forces.push(`Excellent ! Vous présentez plusieurs aspects de votre profil d'élève.`);
      }
      if (!elementsEleve.objectifs) {
        analyse.faiblesses.push("Vous n'expliquez pas ce que vous espérez apprendre durant ce stage.");
      } else {
        analyse.forces.push("Parfait ! Vous exprimez vos objectifs d'apprentissage.");
      }
      if (/expérience professionnelle|compétence technique|expertise|carrière/i.test(texte)) {
        analyse.corrections.push("Adaptez votre vocabulaire à votre statut d'élève. Évitez les termes trop professionnels.");
      }
      return analyse;
    }

    function analyserConclusion(texte) {
      const analyse = { forces: [], faiblesses: [], corrections: [], suggestions: [] };
      if (!/découvrir|apprendre|observer|voir|comprendre|métier|profession|activité/i.test(texte)) {
        analyse.faiblesses.push("Vous n'exprimez pas votre motivation à découvrir les métiers de l'entreprise.");
      } else {
        analyse.forces.push("Parfait ! Vous montrez votre motivation à découvrir l'entreprise.");
      }
      if (!/entretien|rencontre|rencontrer|échanger|discuter|téléphone|appel/i.test(texte)) {
        analyse.faiblesses.push("Vous ne proposez pas d'entretien ou de contact.");
      } else {
        analyse.forces.push("Bien ! Vous proposez un contact.");
      }
      if (!/remercie|merci|reconnaissance|attention|considération/i.test(texte)) {
        analyse.suggestions.push("Terminez poliment : 'Je vous remercie de l'attention portée à ma demande'");
      } else {
        analyse.forces.push("Excellent ! Vous remerciez poliment.");
      }
      return analyse;
    }

    function analyserCoordonnees(texte) {
      const analyse = { forces: [], faiblesses: [], corrections: [], suggestions: [] };
      const lignes = texte.split('\n').filter(l => l.trim());
      const emailRegex = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/;
      const email = texte.match(emailRegex);
      if (!email) {
        analyse.faiblesses.push("Aucune adresse email détectée.");
      } else if (email[0].includes('hotmail') || email[0].includes('yahoo')) {
        analyse.suggestions.push("Privilégiez une adresse Gmail ou un email professionnel.");
      } else {
        analyse.forces.push("Adresse email présente et professionnelle.");
      }
      const telRegex = /(?:(?:\+|00)33|0)\s*[1-9](?:[\s.-]*\d{2}){4}/;
      if (!telRegex.test(texte)) {
        analyse.faiblesses.push("Numéro de téléphone manquant ou mal formaté.");
      } else {
        analyse.forces.push("Numéro de téléphone bien formaté.");
      }
      if (lignes.length < 3) {
        analyse.faiblesses.push("Structure incomplète. Attendu : Nom/Prénom, Adresse, Contact (3 lignes minimum).");
      }
      return analyse;
    }

    function analyserObjet(texte) {
      const analyse = { forces: [], faiblesses: [], corrections: [], suggestions: [] };
      if (!texte.toLowerCase().startsWith('objet')) {
        analyse.corrections.push("Commencez par 'Objet :' (avec les deux points)");
      }
      if (!/stage|observation|découverte/i.test(texte)) {
        analyse.faiblesses.push("Utilisez le vocabulaire approprié : 'stage d'observation'.");
      }
      if (!/février|9.*13.*février|du 9 au 13/i.test(texte)) {
        analyse.faiblesses.push("Précisez les dates exactes : du 9 au 13 février 2026.");
      } else {
        analyse.forces.push("Parfait ! Les dates du stage sont précisées.");
      }
      if (/candidature|poste|emploi|embauche/i.test(texte)) {
        analyse.corrections.push("Évitez 'candidature' ou 'poste'. Écrivez plutôt 'Demande de stage d'observation'.");
      }
      return analyse;
    }

    function analyserGeneral(texte, type) {
      const analyse = { forces: [], faiblesses: [], corrections: [], suggestions: [] };
      const erreursFrequentes = [
        { pattern: /\ba\s+(?=faire|voir|dire|partir)/g, correction: "à", erreur: "a" },
        { pattern: /\bsa\s+(?=va|marche|fonctionne)/g, correction: "ça", erreur: "sa" },
      ];
      erreursFrequentes.forEach(erreur => {
        if (erreur.pattern.test(texte)) {
          analyse.corrections.push(`Attention : "${erreur.erreur}" → "${erreur.correction}"`);
        }
      });
      if (!/[.!?]$/.test(texte.trim()) && type !== 'signature' && type !== 'date') {
        analyse.corrections.push("Terminez par un point.");
      }
      return analyse;
    }

    function genererFeedbackPersonnalise(analyse) {
      let feedback = [];
      let type = 'success';
      if (analyse.corrections.length > 0) {
        feedback.push("🔴 À CORRIGER IMMÉDIATEMENT :");
        analyse.corrections.forEach(correction => {
          feedback.push(`• ${correction}`);
        });
        type = 'error';
      }
      if (analyse.faiblesses.length > 0) {
        feedback.push("⚠️ POINTS À AMÉLIORER :");
        analyse.faiblesses.forEach(faiblesse => {
          feedback.push(`• ${faiblesse}`);
        });
        if (type !== 'error') type = 'warning';
      }
      if (analyse.suggestions.length > 0) {
        feedback.push("💡 SUGGESTIONS D'AMÉLIORATION :");
        analyse.suggestions.forEach(suggestion => {
          feedback.push(`• ${suggestion}`);
        });
      }
      if (feedback.length === 0) {
        feedback.push("🎉 EXCELLENT ! Cette section est parfaitement rédigée !");
        feedback.push("Votre texte est clair, bien structuré et sans erreur.");
      } else if (analyse.forces.length > 0) {
        feedback.push("");
        feedback.push("👏 Bon travail ! Apportez ces quelques améliorations et ce sera parfait !");
      }
      return {
        message: feedback.join('\n'),
        type: type
      };
    }

    const loadingModal = document.getElementById('loading-modal');

    async function corriger(fieldId) {
      const field = document.getElementById(fieldId);
      const feedbackElement = document.getElementById('fb-' + fieldId);
      const feedbackIaElement = document.getElementById('fb-ia-' + fieldId);
      const value = field.value.trim();
      if (!value) {
        showFeedback(feedbackElement, "❌ Ce champ est obligatoire. Veuillez le remplir pour le corriger.", 'error');
        return;
      }
      loadingModal.style.display = 'flex';
      const analyse = analyserReponseEleve(value, fieldId);
      const result = genererFeedbackPersonnalise(analyse);
      showFeedback(feedbackElement, result.message, result.type);
      const iaAdvice = await corrigerAvecIA(value, fieldId);
      if (iaAdvice) {
        showFeedback(feedbackIaElement, iaAdvice, 'ai');
      }
      loadingModal.style.display = 'none';
      updateProgress();
    }

    function showFeedback(element, message, type) {
      if (type === 'ai') {
        element.textContent = message;
        element.style.display = 'block';
        return;
      }
      if (!message) {
        element.style.display = 'none';
        return;
      }
      element.textContent = message;
      element.className = `feedback ${type} p-2 mt-2 rounded-md`;
      element.style.display = 'block';
      element.style.opacity = '0';
      element.style.transform = 'translateY(-10px)';
      setTimeout(() => {
        element.style.transition = 'all 0.3s ease';
        element.style.opacity = '1';
        element.style.transform = 'translateY(0)';
      }, 50);
    }

    function showModal(title, message) {
      const modal = document.getElementById('message-modal');
      modal.querySelector('h3').textContent = title;
      modal.querySelector('p').textContent = message;
      modal.style.display = 'flex';
      document.getElementById('modal-close').onclick = () => {
        modal.style.display = 'none';
      };
    }

    function updateProgress() {
      const fields = ['coordonnees', 'entreprise', 'date', 'objet', 'salutation', 'intro', 'developpement', 'conclusion', 'politesse', 'signature'];
      let completed = 0;
      fields.forEach(fieldId => {
        const value = document.getElementById(fieldId).value.trim();
        if (value && !value.includes('[') && !value.includes(']')) {
          completed++;
        }
      });
      const percentage = (completed / fields.length) * 100;
      document.getElementById('progress').style.width = percentage + '%';
      document.getElementById('progress-text').textContent = `Progression : ${completed}/${fields.length} sections complétées`;
    }

    function genererHtmlPourApercu() {
      const coordonnees = document.getElementById('coordonnees').value.trim();
      const entreprise = document.getElementById('entreprise').value.trim();
      const date = document.getElementById('date').value.trim();
      const objet = document.getElementById('objet').value.trim();
      const salutation = document.getElementById('salutation').value.trim();
      const intro = document.getElementById('intro').value.trim();
      const developpement = document.getElementById('developpement').value.trim();
      const conclusion = document.getElementById('conclusion').value.trim();
      const politesse = document.getElementById('politesse').value.trim();
      const signature = document.getElementById('signature').value.trim();

      // Séparer le lieu et la date
      const dateParts = date.split(', le ');
      const lieu = dateParts[0] ? dateParts[0] + ',' : '';
      const formattedDate = dateParts[1] ? 'le ' + dateParts[1] : '';

      const html = `
        <div class="preview-print-coords">
          ${coordonnees.split('\n').map(line => `<p>${line}</p>`).join('')}
        </div>
        <div class="preview-print-right">
          <p>${entreprise.split('\n').join('<br>')}</p>
          <p></p> <!-- Saut de ligne -->
          <p>${lieu}</p>
          <p>${formattedDate}</p>
        </div>
        <h2 class="preview-print-objet">${objet}</h2>
        <p>${salutation}</p>
        <p class="mt-4">${intro}</p>
        <p class="mt-4">${developpement}</p>
        <p class="mt-4">${conclusion}</p>
        <p class="mt-4">${politesse}</p>
        <div class="preview-print-signature">
          <p>${signature}</p>
        </div>
      `;
      return html;
    }

    function showPreviewPage() {
      const mainPage = document.getElementById('main-page');
      const previewPage = document.getElementById('preview-page');
      const previewContent = document.getElementById('preview-content');
      previewContent.innerHTML = genererHtmlPourApercu();
      mainPage.style.display = 'none';
      previewPage.style.display = 'block';
    }

    function showEditPage() {
      const mainPage = document.getElementById('main-page');
      const previewPage = document.getElementById('preview-page');
      previewPage.style.display = 'none';
      mainPage.style.display = 'block';
    }

    document.addEventListener('DOMContentLoaded', () => {
      updateProgress();
    });
  </script>
</body>
</html>


