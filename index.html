<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lettre de motivation ‚Äî Outil d'apprentissage</title>
  <style>
    :root{
      --g1:#667eea; --g2:#764ba2; --ok:#4caf50; --warn:#ffc107; --err:#dc3545;
      --page-w:210mm; --page-h:297mm;
    }
    *{box-sizing:border-box}
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: linear-gradient(135deg, var(--g1) 0%, var(--g2) 100%);
      padding: 20px; margin: 0; min-height: 100vh;
      -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility;
    }
    .container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 1fr 320px; gap: 20px; }
    .page {
      background: white; width: var(--page-w); min-height: var(--page-h);
      padding: 20mm; box-shadow: 0 10px 30px rgba(0,0,0,.2); border-radius: 8px;
      font-size: 12pt; line-height: 1.6; position: relative;
    }
    .sidebar { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,.2); height: fit-content; position: sticky; top: 20px; }
    .coords { display: flex; justify-content: space-between; align-items: flex-start; gap: 20px; margin-bottom: 30px; }
    .right { text-align: right; }
    .right-block { display: flex; flex-direction: column; align-items: flex-end; gap: 12px; width: 100%; }

    textarea, input {
      width: 100%; border: 2px solid #e0e0e0; border-radius: 6px; resize: none;
      font: inherit; line-height: inherit; background: #fafafa; outline: none; padding: 8px;
      transition: all .25s ease; text-align: justify;
    }
    input { text-align: left; }
    textarea:focus, input:focus { border-color: var(--g1); background: #fff; box-shadow: 0 0 0 3px rgba(102,126,234,.12); }

    .objet { font-weight: bold; margin: 20px 0; }

    .feedback { font-size: 11pt; padding: 10px; border-radius: 6px; margin-top: 8px; display: none; border-left: 4px solid; white-space: pre-line; }
    .feedback.success { background: #e8f5e8; color: #2d5a2d; border-color: var(--ok); }
    .feedback.warning { background: #fff3cd; color: #856404; border-color: var(--warn); }
    .feedback.error { background: #f8d7da; color: #721c24; border-color: var(--err); }

    .field { position: relative; margin-bottom: 20px; }
    .field .tools { position:absolute; top:-38px; right:0; display:flex; gap:8px; z-index:10 }
    .btn {
      background: linear-gradient(135deg, var(--g1) 0%, var(--g2) 100%);
      color:#fff; border:none; padding:8px 14px; border-radius:20px; cursor:pointer; font-size:11pt; transition:all .25s; display:inline-flex; align-items:center; gap:.4rem
    }
    .btn:hover{ transform: translateY(-2px); box-shadow: 0 6px 18px rgba(102,126,234,.35) }
    .btn.outline{ background:#fff; color:#333; border:2px solid #e0e0e0 }

    .help-section { margin-bottom: 25px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid var(--g1); }
    .help-section h3 { margin: 0 0 10px 0; color: #333; font-size: 14pt; }
    .help-section p { margin: 0; color: #666; font-size: 11pt; line-height: 1.4; }

    .inline-hint{ font-size:10pt; color:#777; margin-top:6px }

    .progress { width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; margin-bottom: 10px; }
    .progress-bar { height: 100%; background: linear-gradient(135deg, var(--g1) 0%, var(--g2) 100%); width: 0%; transition: width .4s ease; }

    .print-button { position: fixed; bottom: 30px; right: 30px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 15px 22px; border-radius: 50px; cursor: pointer; font-size: 14pt; font-weight: 700; box-shadow: 0 8px 25px rgba(40,167,69,.3); transition: all .25s; z-index: 1000; }
    .print-button:hover { transform: translateY(-3px); box-shadow: 0 12px 35px rgba(40,167,69,.4); }

    .meter { font-size: 11px; color:#666; display:flex; gap:8px; align-items:center }
    .meter .dot{ width:8px; height:8px; border-radius:50%; background:#ccc }

    /* Style pour la date sur deux lignes */
    .date-container { display: flex; flex-direction: column; align-items: flex-end; width: 100%; }
    .date-input { text-align: right; margin-bottom: 4px; width: 100%; }
    .date-input.small { font-size: 11pt; }

    /* Alignement des champs de droite */
    .right-column { width: 45%; display: flex; flex-direction: column; align-items: flex-end; }
    .right-column .field { width: 100%; }

    /* ===== Impression ===== */
    @media print {
      @page { size: A4; margin: 12mm; }
      html, body { background: #fff !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      body{ padding:0 }
      .container { display: block; max-width: none; }
      .sidebar, .print-button, .tools, .feedback { display: none !important; }
      .page { box-shadow: none; border-radius: 0; margin: 0; padding: 0; width: auto; min-height: auto; }

      /* ‚ö†Ô∏è Ne pas imposer un alignement global qui casse la colonne droite */
      textarea, input {
        border: none !important;
        background: transparent !important;
        padding: 0 !important;
        font-size: 12pt !important;
        line-height: 1.6 !important;
        /* pas de text-align ici */
      }

      /* ‚úÖ Conserver l‚Äôalignement √† droite l√† o√π c‚Äôest voulu */
      .right textarea,
      .right input,
      .right-column .field textarea,
      .right-column .field input,
      .date-input {
        text-align: right !important;
      }

      /* ‚úÖ Aligner √† gauche le reste pour un rendu propre */
      .page .field:not(.right) textarea,
      .page .field:not(.right) input {
        text-align: left !important;
      }

      .coords { margin-bottom: 18mm; }
      .objet { margin: 12mm 0; }

      /* Correction pour la salutation */
      #salutation { color: black !important; }
    }

    @media (max-width: 1100px) { 
      .container { grid-template-columns: 1fr; } 
      .page { width: 100%; } 
      .coords { flex-direction: column; }
      .right-column { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="page" id="page">
      <div class="coords">
        <div class="field" style="flex:1">
          <div class="tools">
            <button class="btn" data-action="corriger" data-target="coordonnees">üìù Corriger</button>
            <button class="btn outline" data-action="exemple" data-target="coordonnees">üìÑ Exemple</button>
          </div>
          <textarea id="coordonnees" rows="4" placeholder="Vos coordonn√©es compl√®tes ici‚Ä¶
Exemple :
L√©a MARTIN (√©l√®ve de 3√®me)
15 rue de la Paix
75001 PARIS
06.12.34.56.78 / lea.martin@email.fr"></textarea>
          <div id="fb-coordonnees" class="feedback"></div>
        </div>

        <div class="right-column">
          <div class="field right">
            <div class="tools">
              <button class="btn" data-action="corriger" data-target="entreprise">üìù Corriger</button>
              <button class="btn outline" data-action="exemple" data-target="entreprise">üìÑ Exemple</button>
            </div>
            <textarea id="entreprise" rows="3" placeholder="Coordonn√©es du destinataire‚Ä¶
Exemple :
Mme Marie MARTIN
Directrice des Ressources Humaines
ENTREPRISE XYZ
12 avenue des Champs
75008 PARIS"></textarea>
            <div id="fb-entreprise" class="feedback"></div>
          </div>

          <div class="field right" style="margin-top:4px;">
            <div class="tools">
              <button class="btn" data-action="date-auto">üìÖ Date auto</button>
              <button class="btn" data-action="corriger" data-target="date">üìù Corriger</button>
            </div>
            <div class="date-container">
              <input id="date-ville" class="date-input small" placeholder="Fait √† [ville]" />
              <input id="date-jour" class="date-input" placeholder="le [jour mois ann√©e]" />
            </div>
            <div class="inline-hint">Astuce : clique sur ¬´ Date auto ¬ª pour ins√©rer la date du jour.</div>
            <div id="fb-date" class="feedback"></div>
          </div>
        </div>
      </div>

      <div class="field objet">
        <div class="tools">
          <button class="btn" data-action="corriger" data-target="objet">üìù Corriger</button>
        </div>
        <input id="objet" placeholder="Objet : Demande de stage d'observation du 9 au 13 f√©vrier 2026" />
        <div id="fb-objet" class="feedback"></div>
      </div>

      <div class="field">
        <div class="tools">
          <button class="btn" data-action="corriger" data-target="salutation">üìù Corriger</button>
        </div>
        <input id="salutation" placeholder="Madame, Monsieur," style="color: black;" />
        <div class="inline-hint">Utilise ¬´ Madame, Monsieur, ¬ª si tu ne connais pas la civilit√© exacte.</div>
        <div id="fb-salutation" class="feedback"></div>
      </div>

      <div class="field">
        <div class="tools">
          <button class="btn" data-action="corriger" data-target="intro">üìù Corriger</button>
          <span class="meter"><span class="dot" id="dot-intro"></span><span id="wc-intro">0 mots</span></span>
        </div>
        <textarea id="intro" rows="4" placeholder="Paragraphe d'introduction (3-4 lignes)
Pr√©sente-toi comme √©l√®ve de 3√®me, explique pourquoi tu contactes l'entreprise (stage obligatoire) et ce qui t'int√©resse dans leur domaine d'activit√©‚Ä¶"></textarea>
        <div id="fb-intro" class="feedback"></div>
      </div>

      <div class="field">
        <div class="tools">
          <button class="btn" data-action="corriger" data-target="developpement">üìù Corriger</button>
          <span class="meter"><span class="dot" id="dot-developpement"></span><span id="wc-developpement">0 mots</span></span>
        </div>
        <textarea id="developpement" rows="6" placeholder="Paragraphe de d√©veloppement (5-7 lignes)
Mets en avant tes qualit√©s personnelles, tes centres d'int√©r√™t li√©s au domaine, tes r√©sultats si pertinents, et ce que tu esp√®res apprendre‚Ä¶"></textarea>
        <div id="fb-developpement" class="feedback"></div>
      </div>

      <div class="field">
        <div class="tools">
          <button class="btn" data-action="corriger" data-target="conclusion">üìù Corriger</button>
          <span class="meter"><span class="dot" id="dot-conclusion"></span><span id="wc-conclusion">0 mots</span></span>
        </div>
        <textarea id="conclusion" rows="4" placeholder="Paragraphe de conclusion (3-4 lignes)
Montre ta motivation, propose un contact, remercie‚Ä¶"></textarea>
        <div id="fb-conclusion" class="feedback"></div>
      </div>

      <div class="field">
        <div class="tools">
          <button class="btn" data-action="corriger" data-target="politesse">üìù Corriger</button>
        </div>
        <input id="politesse" placeholder="Je vous prie d'agr√©er, Madame, Monsieur, l'expression de mes salutations distingu√©es." />
        <div id="fb-politesse" class="feedback"></div>
      </div>

      <div class="field right" style="margin-top:30px;">
        <div class="tools">
          <button class="btn" data-action="corriger" data-target="signature">üìù Corriger</button>
        </div>
        <input id="signature" placeholder="[Pr√©nom NOM]" />
        <div id="fb-signature" class="feedback"></div>
      </div>
    </div>

    <div class="sidebar">
      <h2>üìö Guide de r√©daction</h2>
      <div class="progress"><div class="progress-bar" id="progress"></div></div>
      <p id="progress-text">Progression : 0/10 sections compl√©t√©es</p>

      <div class="help-section"><h3>üìç Coordonn√©es</h3><p>Nom, adresse, t√©l√©phone, email. Pr√©cise que tu es √©l√®ve de 3√®me.</p></div>
      <div class="help-section"><h3>üè¢ Destinataire</h3><p>Nom du responsable et adresse de l'entreprise. Cherche le nom exact si possible.</p></div>
      <div class="help-section"><h3>üìÖ Date et lieu</h3><p>Format : ¬´ Fait √† [ville], le [jour mois ann√©e] ¬ª.</p></div>
      <div class="help-section"><h3>üéØ Objet</h3><p>¬´ Objet : Demande de stage d'observation ¬ª + dates exactes.</p></div>
      <div class="help-section"><h3>üéì Introduction</h3><p>Qui es-tu, pourquoi l'entreprise, le cadre obligatoire, int√©r√™t pour le domaine.</p></div>
      <div class="help-section"><h3>üí™ D√©veloppement</h3><p>Qualit√©s, centres d'int√©r√™t, r√©sultats, objectifs d'apprentissage.</p></div>
      <div class="help-section"><h3>üéØ Conclusion</h3><p>Motivation, proposition d'entretien/contact, remerciements.</p></div>
      <div class="help-section"><h3>ü§ù Formule de politesse</h3><p>Formule standard et respectueuse.</p></div>

      <div class="help-section">
        <h3>üíæ Sauvegarde automatique</h3>
        <p>Ton travail est enregistr√© dans ce navigateur et restaur√© automatiquement.</p>
      </div>
    </div>
  </div>

  <button class="print-button" id="printBtn" type="button">üñ®Ô∏è Imprimer la lettre</button>

  <script>
    // ====== UTILITAIRES ======
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    function formatDateFr(d = new Date()){
      const fmt = new Intl.DateTimeFormat('fr-FR',{ day:'numeric', month:'long', year:'numeric' });
      return fmt.format(d);
    }

    // ====== ANALYSES ======
    function analyserReponseEleve(texte, typeSection) {
      switch(typeSection) {
        case 'intro':          return analyserIntroduction(texte);
        case 'developpement':  return analyserDeveloppement(texte);
        case 'conclusion':     return analyserConclusion(texte);
        case 'coordonnees':    return analyserCoordonnees(texte);
        case 'objet':          return analyserObjet(texte);
        case 'salutation':     return analyserSalutation(texte);
        case 'politesse':      return analyserPolitesse(texte);
        default:               return analyserGeneral(texte, typeSection);
      }
    }

    function analyserIntroduction(texte) {
      const analyse = { forces: [], faiblesses: [], corrections: [], suggestions: [] };
      const phrases = texte.split(/[.!?]+/).filter(p => p.trim().length > 5);
      if (phrases.length < 2) {
        analyse.faiblesses.push("Ton introduction ne contient qu'une phrase. Vise 2‚Äì3 phrases.");
      }
      if (!/√©l√®ve|3√®me|troisi√®me|coll√®ge|classe/i.test(texte)) {
        analyse.faiblesses.push("Tu ne te pr√©sentes pas comme √©l√®ve de 3√®me.");
        analyse.suggestions.push("Ex. : ‚Äò√âl√®ve de 3√®me au coll√®ge ‚Ä¶‚Äô");
      } else {
        analyse.forces.push("Tu te pr√©sentes comme √©l√®ve de 3√®me : bien !");
      }
      if (!/stage|observation|d√©couvert|obligatoire|s√©quence/i.test(texte)) {
        analyse.faiblesses.push("Contexte du stage d'observation manquant.");
      } else {
        analyse.forces.push("Contexte du stage mentionn√©.");
      }
      if (!/int√©resse|attire|passionne|d√©couvrir|m√©tier|domaine|activit√©/i.test(texte)) {
        analyse.faiblesses.push("Int√©r√™t pour le domaine non exprim√©.");
      }
      if (/candidature|postule|emploi|embauche/i.test(texte)) {
        analyse.corrections.push("√âvite le vocabulaire d'emploi : tu demandes un stage d'observation.");
      }
      return analyse;
    }

    function analyserDeveloppement(texte) {
      const analyse = { forces: [], faiblesses: [], corrections: [], suggestions: [] };
      const phrases = texte.split(/[.!?]+/).filter(p => p.trim().length > 10);
      if (phrases.length < 3) {
        analyse.faiblesses.push("D√©veloppement trop court. Vise 4‚Äì5 phrases.");
      }
      const elementsEleve = {
        qualites: /qualit√©|rigoureux|s√©rieux|curieux|motiv√©|organis√©|autonome|sociable/i.test(texte),
        interets: /passion|int√©r√™t|aime|centre d'int√©r√™t|hobby|activit√©|sport/i.test(texte),
        scolaire: /note|r√©sultat|bulletin|mati√®re|cours|professeur|√©tablissement/i.test(texte),
        objectifs: /apprendre|d√©couvrir|comprendre|observer|voir|conna√Ætre|esp√®re|souhaite/i.test(texte)
      };
      const presents = Object.keys(elementsEleve).filter(k => elementsEleve[k]);
      if (presents.length < 2) {
        analyse.faiblesses.push("Ajoute au moins deux √©l√©ments : qualit√©s, centres d'int√©r√™t, r√©sultats, objectifs.");
      } else {
        analyse.forces.push(`Plusieurs aspects pr√©sents : ${presents.join(', ')}.`);
      }
      if (!elementsEleve.objectifs) analyse.faiblesses.push("Pr√©cise ce que tu veux apprendre/observer.");
      if (/exp√©rience professionnelle|comp√©tence technique|expertise|carri√®re/i.test(texte))
        analyse.corrections.push("Adapte le vocabulaire √† un √©l√®ve (moins professionnel).");
      return analyse;
    }

    function analyserConclusion(texte) {
      const analyse = { forces: [], faiblesses: [], corrections: [], suggestions: [] };
      if (!/d√©couvrir|apprendre|observer|voir|comprendre|m√©tier|profession|activit√©/i.test(texte)) {
        analyse.faiblesses.push("Motivation √† d√©couvrir l'entreprise non exprim√©e.");
      } else { analyse.forces.push("Motivation exprim√©e."); }
      if (!/entretien|rencontre|rencontrer|√©changer|discuter|t√©l√©phone|appel/i.test(texte)) {
        analyse.faiblesses.push("Proposition d'entretien ou de contact manquante.");
      } else { analyse.forces.push("Proposition de contact : bien."); }
      if (!/remercie|merci|reconnaissance|attention|consid√©ration/i.test(texte)) {
        analyse.suggestions.push("Ajoute un remerciement (ex. : ‚ÄòJe vous remercie‚Ä¶‚Äô).");
      }
      return analyse;
    }

    function analyserCoordonnees(texte) {
      const analyse = { forces: [], faiblesses: [], corrections: [], suggestions: [] };
      const lignes = texte.split('\n').filter(l => l.trim());
      const emailRegex = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/;
      const email = texte.match(emailRegex);
      if (!email) {
        analyse.faiblesses.push("Aucune adresse email d√©tect√©e.");
      } else if (/hotmail|yahoo/i.test(email[0])) {
        analyse.suggestions.push("Privil√©gie une adresse Gmail ou scolaire si possible.");
      } else { analyse.forces.push("Adresse email pr√©sente et correcte."); }
      const telRegex = /(?:(?:\+|00)33|0)\s*[1-9](?:[\s.-]*\d{2}){4}/;
      if (!telRegex.test(texte)) {
        analyse.faiblesses.push("Num√©ro de t√©l√©phone manquant ou mal format√© (ex. : 06 12 34 56 78).");
      } else { analyse.forces.push("Num√©ro de t√©l√©phone bien format√©."); }
      if (lignes.length < 3) analyse.faiblesses.push("Structure incompl√®te : Nom/Pr√©nom, Adresse, Contact (‚â• 3 lignes).");
      return analyse;
    }

    function analyserObjet(texte) {
      const analyse = { forces: [], faiblesses: [], corrections: [], suggestions: [] };
      if (!/^\s*objet\s*:/i.test(texte)) analyse.corrections.push("Commence par ‚ÄòObjet :‚Äô.");
      if (!/stage|observation|d√©couverte/i.test(texte)) analyse.faiblesses.push("Utilise ‚Äòstage d'observation‚Äô ou ‚Äòs√©quence d'observation‚Äô.");
      if (!/f√©vrier|9.*13.*f√©vrier|du\s*9\s*au\s*13/i.test(texte)) {
        analyse.faiblesses.push("Pr√©cise les dates exactes (ex. : du 9 au 13 f√©vrier 2026).");
      } else { analyse.forces.push("Dates du stage pr√©cis√©es."); }
      if (/candidature|poste|emploi|embauche/i.test(texte)) analyse.corrections.push("Remplace ‚Äòcandidature‚Äô/‚Äòposte‚Äô par ‚ÄòDemande de stage d'observation‚Äô.");
      return analyse;
    }

    function analyserSalutation(texte){
      const a = { forces: [], faiblesses: [], corrections: [], suggestions: [] };
      if (!/Madame|Monsieur/i.test(texte)) a.corrections.push("Ajoute une civilit√© : ‚ÄòMadame, Monsieur,‚Äô.");
      if (!/,\s*$/.test(texte.trim())) a.corrections.push("Ajoute une virgule en fin de ligne.");
      return a;
    }

    function analyserPolitesse(texte){
      const a = { forces: [], faiblesses: [], corrections: [], suggestions: [] };
      if (!/agr√©er|salutations|distingu√©e|distingu√©es/i.test(texte)) a.suggestions.push("Utilise une formule standard (ex. : ‚ÄòJe vous prie d'agr√©er‚Ä¶‚Äô).");
      if (!/[.!?]$/.test(texte.trim())) a.corrections.push("Termine par un point.");
      return a;
    }

    function analyserGeneral(texte, type){
      const analyse = { forces: [], faiblesses: [], corrections: [], suggestions: [] };
      const erreursFrequentes = [
        { pattern: /\ba\s+(?=faire|voir|dire|partir)/gi, correction: "√†", erreur: "a" },
        { pattern: /\bsa\s+(?=va|marche|fonctionne)/gi, correction: "√ßa", erreur: "sa" },
        { pattern: /\bet\s+(?=[A-Z√â√à])/g, correction: "est", erreur: "et" },
        { pattern: /\bou\s+(?=j'ai|vous|nous)/gi, correction: "o√π", erreur: "ou" }
      ];
      erreursFrequentes.forEach(e => { if (e.pattern.test(texte)) analyse.corrections.push(`Attention : "${e.erreur}" ‚Üí "${e.correction}"`); });
      if (!/[.!?]$/.test(texte.trim()) && type !== 'signature' && type !== 'date') analyse.corrections.push("Termine par un point.");
      return analyse;
    }

    function genererFeedbackPersonnalise(analyse) {
      let feedback = []; let type = 'success';
      if (analyse.corrections.length){ feedback.push("üî¥ √Ä CORRIGER IMM√âDIATEMENT :"); analyse.corrections.forEach(c => feedback.push(`   ‚Ä¢ ${c}`)); type = 'error'; }
      if (analyse.faiblesses.length){ feedback.push("‚ö†Ô∏è POINTS √Ä AM√âLIORER :"); analyse.faiblesses.forEach(f => feedback.push(`   ‚Ä¢ ${f}`)); if (type!=='error') type='warning'; }
      if (analyse.suggestions.length){ feedback.push("üí° SUGGESTIONS D'AM√âLIORATION :"); analyse.suggestions.forEach(s => feedback.push(`   ‚Ä¢ ${s}`)); }
      if (analyse.forces.length){ feedback.push("‚úÖ POINTS FORTS :"); analyse.forces.forEach(f => feedback.push(`   ‚Ä¢ ${f}`)); }
      if (!feedback.length) { feedback.push("üéâ Excellent ! Cette section est bien r√©dig√©e."); }
      return { message: feedback.join('\n'), type };
    }

    // ====== INTERACTIONS ======
    function showFeedback(element, message, type) {
      element.textContent = message; element.className = `feedback ${type}`; element.style.display = 'block'; element.style.opacity = '0'; element.style.transform = 'translateY(-8px)';
      requestAnimationFrame(() => { element.style.transition = 'all .3s ease'; element.style.opacity = '1'; element.style.transform = 'translateY(0)'; });
    }

    function corriger(fieldId) {
      const field = document.getElementById(fieldId);
      const feedback = document.getElementById('fb-' + fieldId);
      const value = (field.value || '').trim();
      if (!value) { showFeedback(feedback, "‚ùå Ce champ est obligatoire. Consulte le guide √† droite pour des conseils.", 'error'); return; }
      const analyse = analyserReponseEleve(value, fieldId);
      const result = genererFeedbackPersonnalise(analyse);
      showFeedback(feedback, result.message, result.type);
      updateProgress();
    }

    function updateProgress() {
      const fields = ['coordonnees','entreprise','date-ville','date-jour','objet','salutation','intro','developpement','conclusion','politesse','signature'];
      let completed = 0;
      fields.forEach(id => {
        const el = document.getElementById(id);
        const value = (el && el.value || '').trim();
        if (value && !/\[|\]/.test(value)) completed++;
      });
      const pct = Math.round((completed / fields.length) * 100);
      document.getElementById('progress').style.width = pct + '%';
      document.getElementById('progress-text').textContent = `Progression : ${completed}/${fields.length} sections compl√©t√©es`;
    }

    function imprimerLettre() {
      const obligatoires = ['coordonnees','entreprise','date-ville','date-jour','objet','intro','developpement','conclusion'];
      const vides = [];
      obligatoires.forEach(id => { const v = (document.getElementById(id).value || '').trim(); if (!v || /\[|\]/.test(v)) vides.push(id); });
      if (vides.length) {
        const ok = confirm("Certaines sections semblent incompl√®tes :\n- " + vides.join("\n- ") + "\n\nVoulez-vous imprimer quand m√™me ?");
        if (!ok) return;
      }
      document.body.classList.add('printing');
      window.print();
      setTimeout(() => document.body.classList.remove('printing'), 500);
    }

    function fillDateAuto(){
      const champVille = document.getElementById('date-ville');
      const champJour = document.getElementById('date-jour');
      if (!champVille.value.trim()) champVille.value = `Fait √† [ville]`;
      if (!champJour.value.trim()) champJour.value = `le ${formatDateFr()}`;
      corriger('date-ville');
      corriger('date-jour');
    }

    function countWords(text){
      return (text.trim().match(/\b[\p{L}'‚Äô-]+\b/gu) || []).length;
    }

    function updateMeters(){
      const pairs = [
        ['intro', 35, 90],
        ['developpement', 60, 140],
        ['conclusion', 25, 70]
      ];
      for (const [id, min, max] of pairs){
        const txt = (document.getElementById(id).value || '');
        const n = countWords(txt);
        document.getElementById('wc-'+id).textContent = `${n} mots`;
        const dot = document.getElementById('dot-'+id);
        if (n===0){ dot.style.background = '#ccc'; }
        else if (n<min){ dot.style.background = '#ffb300'; }
        else if (n>max){ dot.style.background = '#ff7043'; }
        else { dot.style.background = '#66bb6a'; }
      }
    }

    // ====== SAUVEGARDE (localStorage) ======
    const IDS = ['coordonnees','entreprise','date-ville','date-jour','objet','salutation','intro','developpement','conclusion','politesse','signature'];

    function save(){
      const data = {};
      IDS.forEach(id => data[id] = (document.getElementById(id).value || ''));
      localStorage.setItem('lettre_stage_v2', JSON.stringify(data));
    }
    function restore(){
      try{
        const raw = localStorage.getItem('lettre_stage_v2');
        if (!raw) return;
        const data = JSON.parse(raw);
        IDS.forEach(id => { if (data[id] != null) document.getElementById(id).value = data[id]; });
      }catch(e){ console.warn('Restauration impossible', e); }
    }

    // ====== INIT & √âCOUTEURS ======
    function handleInput(){ updateProgress(); updateMeters(); save(); }

    function attachListeners(){
      document.getElementById('printBtn').addEventListener('click', imprimerLettre);

      Array.from(document.querySelectorAll('textarea, input')).forEach(el => {
        if (el.tagName === 'TEXTAREA'){
          const autoresize = () => { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; };
          el.addEventListener('input', autoresize);
          setTimeout(autoresize, 0);
        }
        el.addEventListener('input', handleInput);
        el.addEventListener('blur', handleInput);
      });

      document.body.addEventListener('click', (e) =>{
        const btn = e.target.closest('button'); if (!btn) return;
        const action = btn.getAttribute('data-action');
        if (action === 'corriger'){ 
          const id = btn.getAttribute('data-target'); 
          if (id === 'date') {
            corriger('date-ville');
            corriger('date-jour');
          } else {
            corriger(id); 
          }
        }
        if (action === 'exemple'){
          const id = btn.getAttribute('data-target');
          if (id === 'coordonnees') document.getElementById('coordonnees').value = `L√©a MARTIN (√©l√®ve de 3√®me)\n15 rue de la Paix\n75001 PARIS\n06 12 34 56 78 / lea.martin@email.fr`;
          if (id === 'entreprise') document.getElementById('entreprise').value = `Mme Marie MARTIN\nDirectrice des Ressources Humaines\nENTREPRISE XYZ\n12 avenue des Champs\n75008 PARIS`;
          handleInput();
        }
        if (action === 'date-auto') fillDateAuto();
      });
    }

    restore();
    attachListeners();
    handleInput();
  </script>
</body>
</html>


