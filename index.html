<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lettre de motivation ‚Äî Aper√ßu</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .edit-page {
      width: 210mm;
      min-height: 297mm;
      padding: 20mm;
    }

    textarea,
    input {
      text-align: justify;
    }

    .feedback {
      transition: all 0.3s ease-in-out;
    }

    .feedback.success {
      background: #e8f5e8;
      color: #2d5a2d;
      border-color: #4caf50;
    }

    .feedback.warning {
      background: #fff3cd;
      color: #856404;
      border-color: #ffc107;
    }

    .feedback.error {
      background: #f8d7da;
      color: #721c24;
      border-color: #dc3545;
    }

    .feedback-ai {
      border-left: 4px solid #667eea;
      background-color: #f0f4ff;
      color: #333;
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 0.5rem;
      font-style: italic;
      white-space: pre-line;
      line-height: 1.5;
    }

    #preview-content {
      font-family: 'Times New Roman', serif;
      font-size: 12pt;
      line-height: 1.5;
    }

    .preview-print-coords {
      margin-bottom: 20mm;
    }

    .preview-print-objet {
      margin: 15mm 0;
      font-weight: bold;
      text-align: left;
    }

    .preview-print-right {
      text-align: right;
    }

    .preview-print-signature {
      margin-top: 20mm;
      text-align: right;
    }

    @media print {
      body {
        background: white;
        padding: 0;
        font-family: 'Times New Roman', serif;
      }

      .container,
      .print-button,
      .sidebar,
      #main-page,
      .copy-button,
      .view-button {
        display: none !important;
      }

      #print-content {
        display: block !important;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        box-shadow: none;
        padding: 15mm;
      }

      #print-content p,
      #print-content h1,
      #print-content h2,
      #print-content div {
        margin: 0;
        padding: 0;
      }

      #print-content p {
        text-align: justify;
        margin-bottom: 0.5rem;
      }
    }

    @media (max-width: 1024px) {
      .container {
        grid-template-columns: 1fr;
      }

      .edit-page {
        width: 100%;
      }
    }
  </style>
</head>

<body>
  <div class="container mx-auto grid grid-cols-1 lg:grid-cols-[1fr_300px] gap-5 p-5">
    <div id="main-page" class="edit-page bg-white shadow-xl rounded-lg text-sm leading-relaxed p-8">
      <p class="mb-4">
        Ce paragraphe est un outil destin√© √† vous accompagner dans la r√©daction de votre premi√®re lettre de motivation, √©tape par √©tape.
        Pour une pr√©sentation soign√©e et conforme aux normes, commencez toujours votre texte align√© sur la marge de gauche.
        √âvitez de faire des alin√©as : pr√©f√©rez plut√¥t sauter une ligne entre chaque paragraphe afin d‚Äôa√©rer votre texte.
        Veillez √©galement √† justifier l‚Äôensemble du texte sur la marge de droite.
        Enfin, tenez compte √† la fois du guide de r√©daction situ√© √† droite et des conseils donn√©s lors de la correction.
      </p>
      <div class="flex flex-col sm:flex-row justify-between mb-8">
        <div class="field w-full sm:w-1/2 mb-4 sm:mb-0 relative">
          <button onclick="corriger('coordonnees')"
            class="absolute top-[-30px] right-0 z-10 bg-blue-500 text-white text-xs px-4 py-1.5 rounded-full shadow-md hover:bg-blue-600 transition-all duration-300 transform hover:-translate-y-1">
            üìù Corriger
          </button>
          <textarea id="coordonnees" rows="4"
            class="w-full border-2 border-gray-200 rounded-md p-2 bg-gray-50 focus:border-blue-500 focus:bg-white transition-all resize-y"
            placeholder="Vos coordonn√©es compl√®tes ici..."></textarea>
          <div id="fb-coordonnees" class="feedback p-2 mt-2 rounded-md hidden"></div>
          <div id="fb-ia-coordonnees" class="feedback-ai hidden"></div>
        </div>
        <div class="right-block w-full sm:w-1/2 flex flex-col items-end">
          <div class="field right mb-4 relative">
            <button onclick="corriger('entreprise')"
              class="absolute top-[-30px] right-0 z-10 bg-blue-500 text-white text-xs px-4 py-1.5 rounded-full shadow-md hover:bg-blue-600 transition-all duration-300 transform hover:-translate-y-1">
              üìù Corriger
            </button>
            <textarea id="entreprise" rows="3"
              class="w-full border-2 border-gray-200 rounded-md p-2 bg-gray-50 focus:border-blue-500 focus:bg-white transition-all resize-y"
              placeholder="Coordonn√©es du destinataire..."></textarea>
            <div id="fb-entreprise" class="feedback p-2 mt-2 rounded-md hidden"></div>
            <div id="fb-ia-entreprise" class="feedback-ai hidden"></div>
          </div>
          <div class="field right mb-4 relative">
            <button onclick="corriger('date')"
              class="absolute top-[-30px] right-0 z-10 bg-blue-500 text-white text-xs px-4 py-1.5 rounded-full shadow-md hover:bg-blue-600 transition-all duration-300 transform hover:-translate-y-1">
              üìù Corriger
            </button>
            <input id="date"
              class="w-full border-2 border-gray-200 rounded-md p-2 bg-gray-50 focus:border-blue-500 focus:bg-white transition-all"
              placeholder="Fait √† Paris, le 9 f√©vrier 2026" />
            <div id="fb-date" class="feedback p-2 mt-2 rounded-md hidden"></div>
            <div id="fb-ia-date" class="feedback-ai hidden"></div>
          </div>
        </div>
      </div>
      <div class="field objet relative">
        <button onclick="corriger('objet')"
          class="absolute top-[-30px] right-0 z-10 bg-blue-500 text-white text-xs px-4 py-1.5 rounded-full shadow-md hover:bg-blue-600 transition-all duration-300 transform hover:-translate-y-1">
          üìù Corriger
        </button>
        <input id="objet"
          class="w-full font-bold border-2 border-gray-200 rounded-md p-2 bg-gray-50 focus:border-blue-500 focus:bg-white transition-all"
          placeholder="Objet : Demande de stage d'observation du 9 au 13 f√©vrier 2026" />
        <div id="fb-objet" class="feedback p-2 mt-2 rounded-md hidden"></div>
        <div id="fb-ia-objet" class="feedback-ai hidden"></div>
      </div>
      <div class="field relative">
        <button onclick="corriger('salutation')"
          class="absolute top-[-30px] right-0 z-10 bg-blue-500 text-white text-xs px-4 py-1.5 rounded-full shadow-md hover:bg-blue-600 transition-all duration-300 transform hover:-translate-y-1">
          üìù Corriger
        </button>
        <input id="salutation"
          class="w-full border-2 border-gray-200 rounded-md p-2 bg-gray-50 focus:border-blue-500 focus:bg-white transition-all"
          placeholder="Madame, Monsieur," />
        <div id="fb-salutation" class="feedback p-2 mt-2 rounded-md hidden"></div>
        <div id="fb-ia-salutation" class="feedback-ai hidden"></div>
      </div>
      <div class="field relative">
        <button onclick="corriger('intro')"
          class="absolute top-[-30px] right-0 z-10 bg-blue-500 text-white text-xs px-4 py-1.5 rounded-full shadow-md hover:bg-blue-600 transition-all duration-300 transform hover:-translate-y-1">
          üìù Corriger
        </button>
        <textarea id="intro" rows="4"
          class="w-full border-2 border-gray-200 rounded-md p-2 bg-gray-50 focus:border-blue-500 focus:bg-white transition-all resize-y"
          placeholder="Paragraphe d'introduction..."></textarea>
        <div id="fb-intro" class="feedback p-2 mt-2 rounded-md hidden"></div>
        <div id="fb-ia-intro" class="feedback-ai hidden"></div>
      </div>
      <div class="field relative">
        <button onclick="corriger('developpement')"
          class="absolute top-[-30px] right-0 z-10 bg-blue-500 text-white text-xs px-4 py-1.5 rounded-full shadow-md hover:bg-blue-600 transition-all duration-300 transform hover:-translate-y-1">
          üìù Corriger
        </button>
        <textarea id="developpement" rows="6"
          class="w-full border-2 border-gray-200 rounded-md p-2 bg-gray-50 focus:border-blue-500 focus:bg-white transition-all resize-y"
          placeholder="Paragraphe de d√©veloppement..."></textarea>
        <div id="fb-developpement" class="feedback p-2 mt-2 rounded-md hidden"></div>
        <div id="fb-ia-developpement" class="feedback-ai hidden"></div>
      </div>
      <div class="field relative">
        <button onclick="corriger('conclusion')"
          class="absolute top-[-30px] right-0 z-10 bg-blue-500 text-white text-xs px-4 py-1.5 rounded-full shadow-md hover:bg-blue-600 transition-all duration-300 transform hover:-translate-y-1">
          üìù Corriger
        </button>
        <textarea id="conclusion" rows="4"
          class="w-full border-2 border-gray-200 rounded-md p-2 bg-gray-50 focus:border-blue-500 focus:bg-white transition-all resize-y"
          placeholder="Paragraphe de conclusion..."></textarea>
        <div id="fb-conclusion" class="feedback p-2 mt-2 rounded-md hidden"></div>
        <div id="fb-ia-conclusion" class="feedback-ai hidden"></div>
      </div>
      <div class="field relative">
        <button onclick="corriger('politesse')"
          class="absolute top-[-30px] right-0 z-10 bg-blue-500 text-white text-xs px-4 py-1.5 rounded-full shadow-md hover:bg-blue-600 transition-all duration-300 transform hover:-translate-y-1">
          üìù Corriger
        </button>
        <input id="politesse"
          class="w-full border-2 border-gray-200 rounded-md p-2 bg-gray-50 focus:border-blue-500 focus:bg-white transition-all"
          placeholder="Je vous prie d'agr√©er, Madame, Monsieur, l'expression de mes salutations distingu√©es." />
        <div id="fb-politesse" class="feedback p-2 mt-2 rounded-md hidden"></div>
        <div id="fb-ia-politesse" class="feedback-ai hidden"></div>
      </div>
      <div class="field right mt-10 relative">
        <button onclick="corriger('signature')"
          class="absolute top-[-30px] right-0 z-10 bg-blue-500 text-white text-xs px-4 py-1.5 rounded-full shadow-md hover:bg-blue-600 transition-all duration-300 transform hover:-translate-y-1">
          üìù Corriger
        </button>
        <input id="signature"
          class="w-full border-2 border-gray-200 rounded-md p-2 bg-gray-50 focus:border-blue-500 focus:bg-white transition-all"
          placeholder="[Votre pr√©nom et nom]" />
        <div id="fb-signature" class="feedback p-2 mt-2 rounded-md hidden"></div>
        <div id="fb-ia-signature" class="feedback-ai hidden"></div>
      </div>
    </div>
    <div id="preview-page" class="edit-page bg-white shadow-xl rounded-lg p-8" style="display:none;">
      <div id="preview-content"></div>
      <div class="flex justify-center mt-8">
        <button onclick="showEditPage()"
          class="view-button bg-gray-500 text-white text-lg px-6 py-3 rounded-full font-bold shadow-lg hover:bg-gray-600 transition-all duration-300 transform hover:-translate-y-1">
          Retour √† l'√©dition
        </button>
      </div>
    </div>
    <div class="sidebar bg-white shadow-xl rounded-lg p-5 h-fit sticky top-5">
      <h2 class="text-xl font-bold mb-4">üìö Guide de r√©daction</h2>
      <div class="progress h-2 bg-gray-200 rounded-full overflow-hidden mb-4">
        <div id="progress" class="progress-bar h-full w-0 bg-gradient-to-r from-blue-500 to-purple-500 transition-all duration-500">
        </div>
      </div>
      <p id="progress-text" class="text-sm text-gray-600 mb-6">Progression : 0/10 sections compl√©t√©es</p>
      <div class="help-section p-4 bg-gray-100 rounded-lg border-l-4 border-blue-500 mb-4">
        <h3 class="font-semibold text-lg text-gray-800">üìç Coordonn√©es</h3>
        <p class="text-sm text-gray-600 mt-1">Vos informations personnelles compl√®tes : nom, adresse, t√©l√©phone et email.
          Pr√©cisez que vous √™tes √©l√®ve de 3√®me.</p>
      </div>
      <div class="help-section p-4 bg-gray-100 rounded-lg border-l-4 border-blue-500 mb-4">
        <h3 class="font-semibold text-lg text-gray-800">üè¢ Destinataire</h3>
        <p class="text-sm text-gray-600 mt-1">Nom du responsable et adresse de l'entreprise. Recherchez le nom exact du
          responsable si possible.</p>
      </div>
      <div class="help-section p-4 bg-gray-100 rounded-lg border-l-4 border-blue-500 mb-4">
        <h3 class="font-semibold text-lg text-gray-800">üìÖ Date et lieu</h3>
        <p class="text-sm text-gray-600 mt-1">Lieu de r√©daction et date compl√®te. Format : "Fait √† [ville], le [jour mois
          ann√©e]"</p>
      </div>
      <div class="help-section p-4 bg-gray-100 rounded-lg border-l-4 border-blue-500 mb-4">
        <h3 class="font-semibold text-lg text-gray-800">üéØ Objet</h3>
        <p class="text-sm text-gray-600 mt-1">Pr√©cisez "Demande de stage d'observation" avec les dates exactes du stage (9-13
          f√©vrier 2026).</p>
      </div>
      <div class="help-section p-4 bg-gray-100 rounded-lg border-l-4 border-blue-500 mb-4">
        <h3 class="font-semibold text-lg text-gray-800">üéì Introduction</h3>
        <p class="text-sm text-gray-600 mt-1">Pr√©sentez-vous comme √©l√®ve de 3√®me, mentionnez votre coll√®ge, expliquez le
          cadre obligatoire du stage et votre int√©r√™t pour le domaine d'activit√© de l'entreprise.</p>
      </div>
      <div class="help-section p-4 bg-gray-100 rounded-lg border-l-4 border-blue-500 mb-4">
        <h3 class="font-semibold text-lg text-gray-800">üí™ D√©veloppement</h3>
        <p class="text-sm text-gray-600 mt-1">Mettez en avant vos qualit√©s personnelles, vos centres d'int√©r√™t li√©s au
          domaine, vos r√©sultats scolaires. Expliquez ce que vous esp√©rez d√©couvrir et apprendre.</p>
      </div>
      <div class="help-section p-4 bg-gray-100 rounded-lg border-l-4 border-blue-500 mb-4">
        <h3 class="font-semibold text-lg text-gray-800">üéØ Conclusion</h3>
        <p class="text-sm text-gray-600 mt-1">Montrez votre motivation pour d√©couvrir les m√©tiers de l'entreprise, proposez
          un entretien t√©l√©phonique ou une rencontre, et remerciez.</p>
      </div>
      <div class="help-section p-4 bg-gray-100 rounded-lg border-l-4 border-blue-500 mb-4">
        <h3 class="font-semibold text-lg text-gray-800">ü§ù Formule de politesse</h3>
        <p class="text-sm text-gray-600 mt-1">Formule standard et respectueuse. Reprenez la civilit√© utilis√©e en d√©but de
          lettre.</p>
      </div>
    </div>
  </div>
  <div class="flex justify-center md:justify-end gap-4 p-5 md:fixed md:bottom-8 md:right-8 md:p-0 z-50">
    <button onclick="showPreviewPage()"
      class="view-button bg-gray-500 text-white text-lg px-6 py-3 rounded-full font-bold shadow-lg hover:bg-gray-600 transition-all duration-300 transform hover:-translate-y-1">
      üëÄ Voir l'aper√ßu
    </button>
  </div>
  <div id="print-content" style="display: none;"></div>
  <textarea id="copy-area" style="position: absolute; left: -9999px;"></textarea>
  <div id="loading-modal"
    class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center hidden z-[1001]">
    <div class="bg-white p-6 rounded-lg text-center shadow-xl">
      <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-blue-500 mx-auto mb-4"></div>
      <p class="text-gray-700 font-medium">Correction et analyse en cours...</p>
    </div>
  </div>
  <div id="message-modal"
    class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center hidden z-[1002]">
    <div class="bg-white p-6 rounded-lg text-center shadow-xl max-w-sm">
      <h3 class="text-xl font-bold mb-4"></h3>
      <p class="text-gray-700 mb-6"></p>
      <div class="flex justify-center gap-4">
        <button id="modal-close"
          class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">OK</button>
      </div>
    </div>
  </div>
  <script>
    async function corrigerAvecIA(text, typeSection) {
      const prompt = `En tant que tuteur bienveillant et p√©dagogue, analyse le texte suivant d'un(e) √©l√®ve de 3√®me qui r√©dige une lettre de motivation. Ton r√¥le est de lui donner des conseils constructifs et personnalis√©s pour am√©liorer son texte, en t'appuyant sur le guide de r√©daction √† droite. Tu dois :
      1. V√©rifier la clart√©, le ton et la structure de la section.
      2. Rep√©rer les faiblesses et les points √† am√©liorer.
      3. Proposer des suggestions concr√®tes pour rendre son texte plus impactant, sans le r√©√©crire compl√®tement.
      4. Adapter le niveau de tes conseils √† un(e) coll√©gien(ne).
      5. Ne mentionne pas que tu es une IA.
      6. Formate ta r√©ponse en une seule phrase. Par exemple: "Je pense qu'il manque le nom du coll√®ge."
      Voici le texte de la section '${typeSection}':
      """
      ${text}
      """
      `;
      let attempts = 0;
      const maxAttempts = 3;
      let aiAdvice = '';
      while (attempts < maxAttempts) {
        try {
          const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
          const payload = { contents: chatHistory };
          const apiKey = "";
          const apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=" + apiKey;
          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (!response.ok) {
            throw new Error(`API call failed with status: ${response.status}`);
          }
          const result = await response.json();
          if (result.candidates && result.candidates.length > 0 &&
            result.candidates[0].content && result.candidates[0].content.parts &&
            result.candidates[0].content.parts.length > 0) {
            aiAdvice = result.candidates[0].content.parts[0].text;
            break;
          } else {
            console.error("Unexpected API response structure:", result);
            throw new Error("API response was not as expected.");
          }
        } catch (error) {
          console.error("Error correcting text with IA:", error);
          attempts++;
          if (attempts < maxAttempts) {
            const delay = Math.pow(2, attempts) * 1000;
            await new Promise(res => setTimeout(res, delay));
          } else {
            return "Une erreur est survenue lors de l'analyse par l'IA. Veuillez r√©essayer plus tard.";
          }
        }
      }
      return aiAdvice;
    }

    function analyserReponseEleve(texte, typeSection) {
      switch (typeSection) {
        case 'intro': return analyserIntroduction(texte);
        case 'developpement': return analyserDeveloppement(texte);
        case 'conclusion': return analyserConclusion(texte);
        case 'coordonnees': return analyserCoordonnees(texte);
        case 'objet': return analyserObjet(texte);
        case 'salutation':
        case 'politesse':
        case 'signature':
        case 'date':
        case 'entreprise':
        default: return analyserGeneral(texte, typeSection);
      }
    }

    function analyserIntroduction(texte) {
      const analyse = { forces: [], faiblesses: [], corrections: [], suggestions: [] };
      const phrases = texte.split(/[.!?]+/).filter(p => p.trim().length > 5);
      if (phrases.length < 2) {
        analyse.faiblesses.push("Votre introduction est trop courte. D√©veloppez en 2-3 phrases minimum.");
      }
      if (!/√©l√®ve|3√®me|troisi√®me|coll√®ge|classe/i.test(texte)) {
        analyse.faiblesses.push("Vous ne vous pr√©sentez pas comme √©l√®ve de 3√®me. Mentionnez votre statut scolaire.");
      } else {
        analyse.forces.push("Parfait ! Vous vous pr√©sentez bien comme √©l√®ve de 3√®me.");
      }
      if (!/stage|observation|d√©couvert|obligatoire|s√©quence/i.test(texte)) {
        analyse.faiblesses.push("Vous n'expliquez pas le contexte du stage d'observation.");
      } else {
        analyse.forces.push("Bien ! Vous mentionnez le contexte du stage d'observation.");
      }
      if (!/int√©resse|attire|passionne|d√©couvrir|m√©tier|domaine|activit√©/i.test(texte)) {
        analyse.faiblesses.push("Vous n'exprimez pas votre int√©r√™t pour le domaine d'activit√©.");
      }
      if (/candidature|postule|emploi|embauche/i.test(texte)) {
        analyse.corrections.push("√âvitez le vocabulaire de candidature d'emploi. Vous demandez un stage d'observation, pas un travail.");
      }
      return analyse;
    }

    function analyserDeveloppement(texte) {
      const analyse = { forces: [], faiblesses: [], corrections: [], suggestions: [] };
      const phrases = texte.split(/[.!?]+/).filter(p => p.trim().length > 10);
      if (phrases.length < 3) {
        analyse.faiblesses.push("Votre d√©veloppement est trop court. D√©veloppez en 4-5 phrases minimum.");
      }
      const elementsEleve = {
        qualites: /qualit√©|rigoureux|s√©rieux|curieux|motiv√©|organis√©|autonome|sociable/i.test(texte),
        interets: /passion|int√©r√™t|aime|centre d'int√©r√™t|hobby|activit√©|sport/i.test(texte),
        scolaire: /note|r√©sultat|bulletin|mati√®re|cours|professeur|√©tablissement/i.test(texte),
        objectifs: /apprendre|d√©couvrir|comprendre|observer|voir|conna√Ætre|esp√®re|souhaite/i.test(texte)
      };
      const elementsPresents = Object.keys(elementsEleve).filter(key => elementsEleve[key]);
      if (elementsPresents.length < 2) {
        analyse.faiblesses.push("Votre profil d'√©l√®ve manque d'√©l√©ments. Mentionnez au moins 2 aspects parmi : qualit√©s personnelles, centres d'int√©r√™t, r√©sultats scolaires, objectifs du stage.");
      } else {
        analyse.forces.push(`Excellent ! Vous pr√©sentez plusieurs aspects de votre profil d'√©l√®ve.`);
      }
      if (!elementsEleve.objectifs) {
        analyse.faiblesses.push("Vous n'expliquez pas ce que vous esp√©rez apprendre durant ce stage.");
      } else {
        analyse.forces.push("Parfait ! Vous exprimez vos objectifs d'apprentissage.");
      }
      if (/exp√©rience professionnelle|comp√©tence technique|expertise|carri√®re/i.test(texte)) {
        analyse.corrections.push("Adaptez votre vocabulaire √† votre statut d'√©l√®ve. √âvitez les termes trop professionnels.");
      }
      return analyse;
    }

    function analyserConclusion(texte) {
      const analyse = { forces: [], faiblesses: [], corrections: [], suggestions: [] };
      if (!/d√©couvrir|apprendre|observer|voir|comprendre|m√©tier|profession|activit√©/i.test(texte)) {
        analyse.faiblesses.push("Vous n'exprimez pas votre motivation √† d√©couvrir les m√©tiers de l'entreprise.");
      } else {
        analyse.forces.push("Parfait ! Vous montrez votre motivation √† d√©couvrir l'entreprise.");
      }
      if (!/entretien|rencontre|rencontrer|√©changer|discuter|t√©l√©phone|appel/i.test(texte)) {
        analyse.faiblesses.push("Vous ne proposez pas d'entretien ou de contact.");
      } else {
        analyse.forces.push("Bien ! Vous proposez un contact.");
      }
      if (!/remercie|merci|reconnaissance|attention|consid√©ration/i.test(texte)) {
        analyse.suggestions.push("Terminez poliment : 'Je vous remercie de l'attention port√©e √† ma demande'");
      } else {
        analyse.forces.push("Excellent ! Vous remerciez poliment.");
      }
      return analyse;
    }

    function analyserCoordonnees(texte) {
      const analyse = { forces: [], faiblesses: [], corrections: [], suggestions: [] };
      const lignes = texte.split('\n').filter(l => l.trim());
      const emailRegex = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/;
      const email = texte.match(emailRegex);
      if (!email) {
        analyse.faiblesses.push("Aucune adresse email d√©tect√©e.");
      } else if (email[0].includes('hotmail') || email[0].includes('yahoo')) {
        analyse.suggestions.push("Privil√©giez une adresse Gmail ou un email professionnel.");
      } else {
        analyse.forces.push("Adresse email pr√©sente et professionnelle.");
      }
      const telRegex = /(?:(?:\+|00)33|0)\s*[1-9](?:[\s.-]*\d{2}){4}/;
      if (!telRegex.test(texte)) {
        analyse.faiblesses.push("Num√©ro de t√©l√©phone manquant ou mal format√©.");
      } else {
        analyse.forces.push("Num√©ro de t√©l√©phone bien format√©.");
      }
      if (lignes.length < 3) {
        analyse.faiblesses.push("Structure incompl√®te. Attendu : Nom/Pr√©nom, Adresse, Contact (3 lignes minimum).");
      }
      return analyse;
    }

    function analyserObjet(texte) {
      const analyse = { forces: [], faiblesses: [], corrections: [], suggestions: [] };
      if (!texte.toLowerCase().startsWith('objet')) {
        analyse.corrections.push("Commencez par 'Objet :' (avec les deux points)");
      }
      if (!/stage|observation|d√©couverte/i.test(texte)) {
        analyse.faiblesses.push("Utilisez le vocabulaire appropri√© : 'stage d'observation'.");
      }
      if (!/f√©vrier|9.*13.*f√©vrier|du 9 au 13/i.test(texte)) {
        analyse.faiblesses.push("Pr√©cisez les dates exactes : du 9 au 13 f√©vrier 2026.");
      } else {
        analyse.forces.push("Parfait ! Les dates du stage sont pr√©cis√©es.");
      }
      if (/candidature|poste|emploi|embauche/i.test(texte)) {
        analyse.corrections.push("√âvitez 'candidature' ou 'poste'. √âcrivez plut√¥t 'Demande de stage d'observation'.");
      }
      return analyse;
    }

    function analyserGeneral(texte, type) {
      const analyse = { forces: [], faiblesses: [], corrections: [], suggestions: [] };
      const erreursFrequentes = [
        { pattern: /\ba\s+(?=faire|voir|dire|partir)/g, correction: "√†", erreur: "a" },
        { pattern: /\bsa\s+(?=va|marche|fonctionne)/g, correction: "√ßa", erreur: "sa" },
      ];
      erreursFrequentes.forEach(erreur => {
        if (erreur.pattern.test(texte)) {
          analyse.corrections.push(`Attention : "${erreur.erreur}" ‚Üí "${erreur.correction}"`);
        }
      });
      if (!/[.!?]$/.test(texte.trim()) && type !== 'signature' && type !== 'date') {
        analyse.corrections.push("Terminez par un point.");
      }
      return analyse;
    }

    function genererFeedbackPersonnalise(analyse) {
      let feedback = [];
      let type = 'success';
      if (analyse.corrections.length > 0) {
        feedback.push("üî¥ √Ä CORRIGER IMM√âDIATEMENT :");
        analyse.corrections.forEach(correction => {
          feedback.push(`‚Ä¢ ${correction}`);
        });
        type = 'error';
      }
      if (analyse.faiblesses.length > 0) {
        feedback.push("‚ö†Ô∏è POINTS √Ä AM√âLIORER :");
        analyse.faiblesses.forEach(faiblesse => {
          feedback.push(`‚Ä¢ ${faiblesse}`);
        });
        if (type !== 'error') type = 'warning';
      }
      if (analyse.suggestions.length > 0) {
        feedback.push("üí° SUGGESTIONS D'AM√âLIORATION :");
        analyse.suggestions.forEach(suggestion => {
          feedback.push(`‚Ä¢ ${suggestion}`);
        });
      }
      if (feedback.length === 0) {
        feedback.push("üéâ EXCELLENT ! Cette section est parfaitement r√©dig√©e !");
        feedback.push("Votre texte est clair, bien structur√© et sans erreur.");
      } else if (analyse.forces.length > 0) {
        feedback.push("");
        feedback.push("üëè Bon travail ! Apportez ces quelques am√©liorations et ce sera parfait !");
      }
      return {
        message: feedback.join('\n'),
        type: type
      };
    }

    const loadingModal = document.getElementById('loading-modal');

    async function corriger(fieldId) {
      const field = document.getElementById(fieldId);
      const feedbackElement = document.getElementById('fb-' + fieldId);
      const feedbackIaElement = document.getElementById('fb-ia-' + fieldId);
      const value = field.value.trim();
      if (!value) {
        showFeedback(feedbackElement, "‚ùå Ce champ est obligatoire. Veuillez le remplir pour le corriger.", 'error');
        return;
      }
      loadingModal.style.display = 'flex';
      const analyse = analyserReponseEleve(value, fieldId);
      const result = genererFeedbackPersonnalise(analyse);
      showFeedback(feedbackElement, result.message, result.type);
      const iaAdvice = await corrigerAvecIA(value, fieldId);
      if (iaAdvice) {
        showFeedback(feedbackIaElement, iaAdvice, 'ai');
      }
      loadingModal.style.display = 'none';
      updateProgress();
    }

    function showFeedback(element, message, type) {
      if (type === 'ai') {
        element.textContent = message;
        element.style.display = 'block';
        return;
      }
      if (!message) {
        element.style.display = 'none';
        return;
      }
      element.textContent = message;
      element.className = `feedback ${type} p-2 mt-2 rounded-md`;
      element.style.display = 'block';
      element.style.opacity = '0';
      element.style.transform = 'translateY(-10px)';
      setTimeout(() => {
        element.style.transition = 'all 0.3s ease';
        element.style.opacity = '1';
        element.style.transform = 'translateY(0)';
      }, 50);
    }

    function showModal(title, message) {
      const modal = document.getElementById('message-modal');
      modal.querySelector('h3').textContent = title;
      modal.querySelector('p').textContent = message;
      modal.style.display = 'flex';
      document.getElementById('modal-close').onclick = () => {
        modal.style.display = 'none';
      };
    }

    function updateProgress() {
      const fields = ['coordonnees', 'entreprise', 'date', 'objet', 'salutation', 'intro', 'developpement', 'conclusion', 'politesse', 'signature'];
      let completed = 0;
      fields.forEach(fieldId => {
        const value = document.getElementById(fieldId).value.trim();
        if (value && !value.includes('[') && !value.includes(']')) {
          completed++;
        }
      });
      const percentage = (completed / fields.length) * 100;
      document.getElementById('progress').style.width = percentage + '%';
      document.getElementById('progress-text').textContent = `Progression : ${completed}/${fields.length} sections compl√©t√©es`;
    }

    function genererHtmlPourApercu() {
      const coordonnees = document.getElementById('coordonnees').value.trim();
      const entreprise = document.getElementById('entreprise').value.trim();
      const date = document.getElementById('date').value.trim();
      const objet = document.getElementById('objet').value.trim();
      const salutation = document.getElementById('salutation').value.trim();
      const intro = document.getElementById('intro').value.trim();
      const developpement = document.getElementById('developpement').value.trim();
      const conclusion = document.getElementById('conclusion').value.trim();
      const politesse = document.getElementById('politesse').value.trim();
      const signature = document.getElementById('signature').value.trim();

      // S√©parer le lieu et la date
      const dateParts = date.split(', le ');
      const lieu = dateParts[0] ? dateParts[0] + ',' : '';
      const formattedDate = dateParts[1] ? 'le ' + dateParts[1] : '';

      const html = `
        <div class="preview-print-coords">
          ${coordonnees.split('\n').map(line => `<p>${line}</p>`).join('')}
        </div>
        <div class="preview-print-right">
          <p>${entreprise.split('\n').join('<br>')}</p>
          <p></p> <!-- Saut de ligne -->
          <p>${lieu}</p>
          <p>${formattedDate}</p>
        </div>
        <h2 class="preview-print-objet">${objet}</h2>
        <p>${salutation}</p>
        <p class="mt-4">${intro}</p>
        <p class="mt-4">${developpement}</p>
        <p class="mt-4">${conclusion}</p>
        <p class="mt-4">${politesse}</p>
        <div class="preview-print-signature">
          <p>${signature}</p>
        </div>
      `;
      return html;
    }

    function showPreviewPage() {
      const mainPage = document.getElementById('main-page');
      const previewPage = document.getElementById('preview-page');
      const previewContent = document.getElementById('preview-content');
      previewContent.innerHTML = genererHtmlPourApercu();
      mainPage.style.display = 'none';
      previewPage.style.display = 'block';
    }

    function showEditPage() {
      const mainPage = document.getElementById('main-page');
      const previewPage = document.getElementById('preview-page');
      previewPage.style.display = 'none';
      mainPage.style.display = 'block';
    }

    document.addEventListener('DOMContentLoaded', () => {
      updateProgress();
    });
  </script>
</body>
</html>


